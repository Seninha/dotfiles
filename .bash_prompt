#!/bin/bash
#
# ~/.bash/prompt
# ==============================================================================
#
# This file creates a modular Prompt.  It is made with prompt blocks  defined in
# section #3 and arranged in order to make a prompt.
#
# The prompt blocks  are made with color  blocks defined in section #2  and with
# functions defined in section #1.
#
# The prompt itself is defined in section #4
#


# 1. Prompt Command
# ==============================================================================

# Defines prompt's color based on the success of the previous command
function success {
  local exit=$?
  if [[ $exit = 0 ]]
  then
    suc_collor="\e[1;34m"	# blue
    suc_value=
  else
    suc_collor="\e[1;41m"	# red
    suc_value=" (${exit})"
  fi
  }

#function load_avg {
#  AVG=$(calc -p "$(uptime | awk '{ print $8 }' | sed 's/,/./ ; s/,$//')*100")
#  if [[ $AVG > 200 ]]
#  then
#    avg_color="\e[44m"	#Azul
#  else
#    avg_color="\e[41m"	#Vermelho
#  fi
#}

# Show current jobs
function job_count {
  totalJobs=$(jobs | wc -l)

  JOBS=""
  if [[ $totalJobs = 1 ]]; then			# Apenas jobs
    JOBS=" ($totalJobs job)"
  elif [[ $totalJobs > 1 ]]; then
    JOBS=" ($totalJobs jobs)"
  fi
  }

# Show current git branch and git branch status
function git_prompt {
	git status &> /dev/null

	if [[ $? = 128 ]] ; then
		git_repo=0
	else
		git_repo=1
	fi

	if [[ $git_repo = 1 ]] ; then
		GIT=
		git_branch=
		git_status=
		git_remote=
		git_color=
		git_count=

		git_branch=$(git status 2> /dev/null | grep -i '^on branch' | cut -d' ' -f3-)

		git_status="staged"
		git status | grep -i '^nothing to commit'  &> /dev/null && git_status="commited"
		git status | grep -i '^changes not staged' &> /dev/null && git_status="modified"
		git status | grep -i '^untracked files'    &> /dev/null && git_status="modified"

		git status | head -4 | grep -i 'ahead'     &> /dev/null && git_remote="→"
		git status | head -4 | grep -i 'diverged'  &> /dev/null && git_remote="<"
		git status | head -4 | grep -i 'behind'    &> /dev/null && git_remote="←"

		[[ $git_status = "modified" ]] && git_color="\e[1;31m"
		[[ $git_status = "commited" ]] && git_color="\e[1;32m"
		[[ $git_status = "staged" ]]   && git_color="\e[1;33m"

		if [[ $git_branch ]] ; then
			if [[ $git_remote ]] ; then
				GIT="${git_color}(git: ${git_branch} ${git_remote})${NONE}"
				git_count=$(( ${#git_remote} + ${#git_branch} ))
				git_count=$(( git_count + 8 ))
			else 
				GIT="${git_color}(git: ${git_branch})${NONE}"
				git_count=${#git_branch}
				git_count=$(( git_count + 7 ))
			fi
		else
			GIT="${git_color}(git)${NONE}"
			git_count=6
		fi

		GIT="\e[${COLUMNS}C\e[${git_count}D${GIT}"

	else
		GIT=
	fi
}


# This command is executed before every prompt
function prompt_command {
  success
  #load_avg
  job_count
  git_prompt
  }

export prompt_command


# 2. Prompt Colors
# ==============================================================================

#
# Uncomment the Blocks you will use and unset them in the end of the file.
#

NONE="\[\e[0m\]" # Default term's fg color

# Regular Colors
#K="\[$(tput setaf 0)\]" 	# Black
R="\[$(tput setaf 1)\]" 	# Red
#G="\[$(tput setaf 2)\]" 	# Green
Y="\[$(tput setaf 3)\]" 	# Yellow
B="\[$(tput setaf 4)\]" 	# Blue
#M="\[$(tput setaf 5)\]" 	# Magenta
#C="\[$(tput setaf 6)\]" 	# Cyan
#W="\[$(tput setaf 7)\]" 	# White

# Color Mode
BLD="\[$(tput bold)\]"
#DIM="\[$(tput dim)\]"
#SMU="\[$(tput smul)\]"
#RMU="\[$(tput rmul)\]"
#REV="\[$(tput rev)\]"
#SMS="\[$(tput smso)\]"
#RMS="\[$(tput rmso)\]"
#SGR="\[$(tput sgr0)\]"

# Background Colors
#BGK="\[$(tput setb 0)\]"
#BGR="\[$(tput setb 1)\]"
#BGG="\[$(tput setb 2)\]"
#BGY="\[$(tput setb 3)\]"
#BGB="\[$(tput setb 4)\]"
#BGM="\[$(tput setb 5)\]"
#BGC="\[$(tput setb 6)\]"
#BGW="\[$(tput setb 7)\]"

# Colors Combinations
RED="${NONE}${BLD}${R}" # Red
BLU="${NONE}${BLD}${B}" # Blue
YELW="${NONE}${Y}"  # Yellow


# 3. Prompt Blocks
# ==============================================================================

HOST="\u@\h"
TIME="\$(date +%H:%M)"
DIR="\w [\$(ls | wc -l) arquivos]"
CMD="\#\$"
JOBS="\$(echo \$JOBS)"
GIT="\$(echo -ne \$GIT)"
EXIT="\$suc_value"
SUC="\$(echo -ne \$suc_collor)"


# 4. Prompt Itself
# ==============================================================================

export PROMPT_COMMAND=prompt_command

export PS1="\n\
${RED}┌─[${TIME}]──[\
${NONE}${SUC}${HOST}${EXIT}\
${RED}] \
${YELW}${DIR}${GIT}\n\
${RED}└─€\
${NONE}\$JOBS ${CMD} "

export PS2="  ${RED}€       ${NONE}"

# 5. Unseting Variables
# ==============================================================================

#
# Variables that are not exported must be unseted here.
#
# If you use vim, you can do the following command to list the non-exported variables:
#
# :r ! cat % | sed -r "/^[ ]*[a-z_A-Z0-9]+=/\!d ; s/^ *([a-z_A-Z0-9]+)=.*/\1/" | tr '\n' ' ' 
#

unset suc_collor suc_value suc_collor suc_value totalJobs JOBS JOBS JOBS NONE R Y B BLD RED BLU YELW SUC HOST TIME DIR CMD JOBS EXIT 

